# cluster-rtt
```
Tool to measure GPU cluster end-to-end round trip time (Rank 0 -> 1 -> 2 -> 3 ... -> N -> 0).
Can also be used to exercise cpu, dram, pcie, nvidia gpu, e-w nic on every rank for a quick sanity test

Dependency: MPI, NCCL, CUDA, Cluster with NVIDIA GPUs connected over network

Compile:
    mpicc -o cluster-rtt cluster-rtt.c -I<path to cuda headers> \
        -I<path to mpi headers> -lnccl -lcudart -L<path to cuda libs> -fopenmp

Usage: ./cluster-rtt [-d] [-v] [-s memory size]
       -d     Enable debugs
       -v     Verbose mode
       -s     Memory size per GPU in units of 8 Bytes.
              For ex: 18253611008 = 136 GiB

Run Example:
    mpirun --map-by node:PE=8 -n 32 -host host1:8,host2:8,host3:8,host4:8 -x OMP_NUM_THREADS=8 \
        /mnt/cl1/training/progs/cluster-rtt -s 18253611008

The above example runs the tool with MPI to measure cluster-rtt and
exercise cpu, dram, pcie, nvidia gpu, e-w nic on every rank of a 4-node cluster
each with 8 H200 GPUs (32 total GPUs) each using 136 GiB memory per GPU

Output: Results from a 4-node (each with 8 H200 GPUs) cluster networked with 400Gbps links 

Buffer Size: 139264.000000 MiB
GRank	LRank	MallocTime	DevMallocTime	MemsetTime	Host2DevCpTime	Dev2HostCpTime	NetworkTime	PatChkTime	PatChkStatus
0	0	0.000005	0.031252	19.466403	7.020085	7.269571	132.533704	1.255874	1
1	0	0.000006	0.075747	20.840919	7.365534	3.827341	8.113426	1.260484	1
2	0	0.000006	0.035786	18.597019	6.886295	3.853666	12.146308	1.260974	1
3	0	0.000005	0.085867	18.972851	7.255472	3.864099	16.263946	1.254596	1
4	1	0.000004	0.053437	19.482320	8.221976	4.666482	20.325034	1.257570	1
5	1	0.000008	0.042382	21.065808	7.386077	3.883629	24.373170	1.256746	1
6	1	0.000005	0.081681	18.680988	6.902502	3.841449	28.470606	1.254553	1
7	1	0.000006	0.045427	18.959895	7.268938	3.877053	32.581688	1.252050	1
8	2	0.000014	0.022835	19.477122	7.848836	5.096032	36.639130	1.254750	1
9	2	0.000006	0.020737	20.986407	7.212494	3.803798	40.696379	1.264713	1
10	2	0.000005	0.036469	18.693761	6.903888	3.871340	44.766118	1.258286	1
11	2	0.000008	0.035981	19.010304	7.025956	3.875433	48.732134	1.254170	1
12	3	0.000005	0.033700	19.522366	8.235362	5.614190	52.771385	1.257818	1
13	3	0.000006	0.038378	20.990513	7.196151	3.804305	56.823119	1.256540	1
14	3	0.000006	0.056398	18.709982	6.902399	3.901310	60.805428	1.253105	1
15	3	0.000006	0.020478	19.038825	7.019223	3.890185	65.028751	1.254025	1
16	4	0.000005	0.032615	19.539488	7.812664	5.912819	69.212038	1.255506	1
17	4	0.000007	0.040951	20.839855	7.439587	3.873845	73.323599	1.259080	1
18	4	0.000008	0.013527	18.706766	6.906116	3.940241	77.504818	1.249136	1
19	4	0.000009	0.037266	19.050954	7.020937	3.957372	81.718921	1.253733	1
20	5	0.000005	0.032042	19.582980	7.375088	6.636495	85.787425	1.257055	1
21	5	0.000008	0.036132	21.030117	7.447134	3.896245	89.952878	1.258522	1
22	5	0.000006	0.047620	18.728936	6.908430	3.837172	94.133597	1.251368	1
23	5	0.000008	0.032380	19.062399	7.023929	3.907139	98.340271	1.288024	1
24	6	0.000005	0.054381	19.608566	8.138365	7.182284	102.497550	1.253953	1
25	6	0.000008	0.027755	21.713519	6.346480	3.838257	106.633374	1.253918	1
26	6	0.000007	0.036181	18.796838	6.615783	3.908148	110.810713	1.251641	1
27	6	0.000008	0.055268	19.090321	6.603679	3.900424	114.981769	1.254889	1
28	7	0.000006	0.039585	6.625465	5.047566	7.238705	118.968748	1.263085	1
29	7	0.000009	0.025217	5.092365	3.790821	3.856875	123.027014	1.258886	1
30	7	0.000005	0.037875	4.781370	3.728866	3.819804	128.286567	1.252520	1
31	7	0.000005	0.046646	5.092824	3.727003	3.829922	132.533509	1.255918	1
Transfer Time Per Rank: 4.141678 secs
Transfer Time Per Rank/MiB: 29.739762 usecs
Cluster RTT: 132.533704 secs
Cluster RTT/MiB: 951.672392 usecs
```
